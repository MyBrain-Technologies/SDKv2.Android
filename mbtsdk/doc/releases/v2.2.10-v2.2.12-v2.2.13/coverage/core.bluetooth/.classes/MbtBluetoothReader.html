<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
        "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html id="htmlId">
<head>
    <title>Coverage Report :: MbtBluetoothReader</title>
    <style type="text/css">
    @import "../../.css/coverage.css";

    </style>
</head>

<body>
<div class="header"></div>

<div class="content">
    <div class="breadCrumbs">
        [ <a href="../../index.html">all classes</a> ]
        [ <a href="../index.html">core.bluetooth</a> ]
    </div>

    <h1>Coverage Summary for Class: MbtBluetoothReader (core.bluetooth)</h1>

    <table class="coverageStats">

        <tr>
            <th class="name">Class</th>
            <th class="coverageStat
">
                Method, %
            </th>
            <th class="coverageStat
">
                Line, %
            </th>
        </tr>
        <tr>
            <td class="name">MbtBluetoothReader</td>
            <td class="coverageStat">
  <span class="percent">
    44,4%
  </span>
                <span class="absValue">
    (4/ 9)
  </span>
            </td>
            <td class="coverageStat">
  <span class="percent">
    15%
  </span>
                <span class="absValue">
    (12/ 80)
  </span>
            </td>
        </tr>
        <tr>
            <td class="name">MbtBluetoothReader$Companion</td>
            <td class="coverageStat">
  <span class="percent">
    100%
  </span>
                <span class="absValue">
    (1/ 1)
  </span>
            </td>
            <td class="coverageStat">
  <span class="percent">
    100%
  </span>
                <span class="absValue">
    (1/ 1)
  </span>
            </td>
        </tr>
        <tr>
            <td class="name"><strong>total</strong></td>
            <td class="coverageStat">
  <span class="percent">
    50%
  </span>
                <span class="absValue">
    (5/ 10)
  </span>
            </td>
            <td class="coverageStat">
  <span class="percent">
    16%
  </span>
                <span class="absValue">
    (13/ 81)
  </span>
            </td>
        </tr>
    </table>

    <br/>
    <br/>


    <div class="sourceCode"><i>1</i>&nbsp;package core.bluetooth
        <i>2</i>&nbsp;
        <i>3</i>&nbsp;import android.util.Log
        <i>4</i>&nbsp;import command.BluetoothCommand
        <i>5</i>&nbsp;import command.CommandInterface
        <i>6</i>&nbsp;import command.DeviceCommand
        <i>7</i>&nbsp;import command.DeviceCommands.*
        <i>8</i>&nbsp;import command.DeviceStreamingCommands.EegConfig
        <i>9</i>&nbsp;import command.OADCommands
        <i>10</i>&nbsp;import config.MbtConfig
        <i>11</i>&nbsp;import core.bluetooth.BluetoothInterfaces.IDeviceInfoMonitor
        <i>12</i>&nbsp;import core.bluetooth.BluetoothState.*
        <i>13</i>&nbsp;import core.bluetooth.lowenergy.MbtBluetoothLE
        <i>14</i>&nbsp;import core.bluetooth.requests.BluetoothRequests
        <i>15</i>&nbsp;import core.bluetooth.requests.ReadRequestEvent
        <i>16</i>&nbsp;import core.bluetooth.spp.MbtBluetoothSPP
        <i>17</i>&nbsp;import core.device.model.DeviceInfo
        <i>18</i>&nbsp;import core.device.model.DeviceInfo.*
        <i>19</i>&nbsp;import core.bluetooth.StreamState.*
        <i>20</i>&nbsp;import engine.clientevents.BaseErrorEvent
        <i>21</i>&nbsp;import engine.clientevents.BluetoothError
        <i>22</i>&nbsp;import eventbus.events.BluetoothResponseEvent
        <i>23</i>&nbsp;import eventbus.events.DeviceInfoEvent
        <i>24</i>&nbsp;import org.apache.commons.lang.ArrayUtils
        <i>25</i>&nbsp;import utils.LogUtils
        <i>26</i>&nbsp;
        <i>27</i>&nbsp;/** Created by Sophie on 02/06/2020.
        <i>28</i>&nbsp; * This class contains all necessary methods to manage the Bluetooth read
        operation with the myBrain peripheral devices.
        <i>29</i>&nbsp; * A read operation is any value read/stream request sent to the headset
        device */
        <b class="fc"><i>30</i>&nbsp;class MbtBluetoothReader(private val manager:
            MbtBluetoothManager) {</b>
        <i>31</i>&nbsp;
        <b class="fc"><i>32</i>&nbsp; companion object {</b>
        <b class="fc"><i>33</i>&nbsp; private val TAG =
            MbtBluetoothReader::class.java.simpleName</b>
        <i>34</i>&nbsp; }
        <i>35</i>&nbsp;
        <i>36</i>&nbsp; fun startReadingDeviceInfo(deviceInfo: DeviceInfo) : BluetoothState? {
        <b class="nc"><i>37</i>&nbsp; manager.tryOperation({ startReadOperation(deviceInfo) },</b>
        <b class="nc"><i>38</i>&nbsp; MbtConfig.getBluetoothReadingTimeout()</b>
        <i>39</i>&nbsp; )
        <b class="nc"><i>40</i>&nbsp; val deviceInfoReadingState = mapOf(</b>
        <b class="nc"><i>41</i>&nbsp; MODEL_NUMBER to READING_SUCCESS,</b>
        <b class="nc"><i>42</i>&nbsp; FW_VERSION to READING_FIRMWARE_VERSION_SUCCESS,</b>
        <b class="nc"><i>43</i>&nbsp; HW_VERSION to READING_HARDWARE_VERSION_SUCCESS,</b>
        <b class="nc"><i>44</i>&nbsp; SERIAL_NUMBER to READING_SERIAL_NUMBER_SUCCESS)</b>
        <b class="nc"><i>45</i>&nbsp; return deviceInfoReadingState[deviceInfo]</b>
        <i>46</i>&nbsp; }
        <i>47</i>&nbsp;
        <i>48</i>&nbsp; /** If the [request][BluetoothRequests] is a [ReadRequestEvent] event, this
        method
        <i>49</i>&nbsp; * is called to parse which read operation is to be executed according to the
        [DeviceInfo].
        <i>50</i>&nbsp; * @param deviceInfo the [DeviceInfo] info that determine which read to
        operation to execute */
        <i>51</i>&nbsp; fun startReadOperation(deviceInfo: DeviceInfo) {
        <b class="nc"><i>52</i>&nbsp; val hasOperationFailed = when (deviceInfo) {</b>
        <b class="nc"><i>53</i>&nbsp; BATTERY -&gt; MbtDataBluetooth.instance.readBattery()
            //Initiates a read battery operation on this correct BtProtocol.</b>
        <b class="nc"><i>54</i>&nbsp; FW_VERSION -&gt; (MbtDataBluetooth.instance as
            IDeviceInfoMonitor).readFwVersion() //Initiates a read firmware version operation on
            this correct BtProtocol</b>
        <b class="nc"><i>55</i>&nbsp; HW_VERSION -&gt; (MbtDataBluetooth.instance as
            IDeviceInfoMonitor).readHwVersion() //Initiates a read hardware version operation on
            this correct BtProtocol</b>
        <b class="nc"><i>56</i>&nbsp; SERIAL_NUMBER -&gt; (MbtDataBluetooth.instance as
            IDeviceInfoMonitor).readSerialNumber() //Initiates a read serial number operation on
            this correct BtProtocol</b>
        <b class="nc"><i>57</i>&nbsp; MODEL_NUMBER -&gt; (MbtDataBluetooth.instance as
            IDeviceInfoMonitor).readModelNumber() //Initiates a read model number operation on this
            correct BtProtocol</b>
        <i>58</i>&nbsp; else -&gt; {
        <b class="nc"><i>59</i>&nbsp; false</b>
        <i>60</i>&nbsp; }
        <i>61</i>&nbsp; }
        <b class="nc"><i>62</i>&nbsp; if (hasOperationFailed) {</b>
        <b class="nc"><i>63</i>&nbsp; manager.setRequestProcessing(false)</b>
        <b class="nc"><i>64</i>&nbsp; manager.notifyEvent(DeviceInfoEvent&lt;Any&gt;(deviceInfo,
            null))</b>
        <i>65</i>&nbsp; }
        <b class="nc"><i>66</i>&nbsp; }</b>
        <i>67</i>&nbsp;
        <i>68</i>&nbsp; /** Initiates the acquisition of EEG data. This method chooses between the
        correct BtProtocol.
        <i>69</i>&nbsp; * If there is already a streaming session in progress, nothing happens and
        the method returns silently. */
        <i>70</i>&nbsp; fun startStreamOperation(enableDeviceStatusMonitoring: Boolean) {
        <b class="nc"><i>71</i>&nbsp; Log.d(TAG, &quot;Bluetooth reader starts streaming&quot;)</b>
        <b class="nc"><i>72</i>&nbsp; if (!MbtDataBluetooth.instance.isConnected) {</b>
        <b class="nc"><i>73</i>&nbsp; manager.notifyStreamStateChanged(DISCONNECTED)</b>
        <b class="nc"><i>74</i>&nbsp; return</b>
        <i>75</i>&nbsp; }
        <b class="nc"><i>76</i>&nbsp; if (MbtDataBluetooth.instance.isStreaming) {</b>
        <b class="nc"><i>77</i>&nbsp; manager.setRequestProcessing(false)</b>
        <b class="nc"><i>78</i>&nbsp; return</b>
        <i>79</i>&nbsp; }
        <b class="nc"><i>80</i>&nbsp; if (enableDeviceStatusMonitoring &amp;&amp;
            MbtDataBluetooth.instance is MbtBluetoothLE) {</b>
        <b class="nc"><i>81</i>&nbsp; (MbtDataBluetooth.instance as
            MbtBluetoothLE).activateDeviceStatusMonitoring()</b>
        <i>82</i>&nbsp; }
        <b class="nc"><i>83</i>&nbsp; manager.tryOperationForResult(</b>
        <b class="nc"><i>84</i>&nbsp; { if (!MbtDataBluetooth.instance.startStream()) {</b>
        <i>85</i>&nbsp; throw BluetoothError.ERROR_WRITE_CHARACTERISTIC_OPERATION
        <i>86</i>&nbsp; }
        <i>87</i>&nbsp; },
        <b class="nc"><i>88</i>&nbsp; BaseErrorEvent { _, _ -&gt;
            MbtDataBluetooth.instance.notifyStreamStateChanged(FAILED) },</b>
        <b class="nc"><i>89</i>&nbsp; { manager.setRequestProcessing(false)},</b>
        <b class="nc"><i>90</i>&nbsp; 6000</b>
        <i>91</i>&nbsp; )
        <b class="nc"><i>92</i>&nbsp; }</b>
        <i>93</i>&nbsp;
        <i>94</i>&nbsp; /** Initiates the acquisition of EEG data from the correct BtProtocol
        <i>95</i>&nbsp; * If there is no streaming session in progress, nothing happens and the
        method returns silently. */
        <i>96</i>&nbsp; fun stopStreamOperation() {
        <b class="nc"><i>97</i>&nbsp; Log.d(TAG, &quot;Bluetooth reader stops streaming&quot;)</b>
        <b class="nc"><i>98</i>&nbsp; if (!MbtDataBluetooth.instance.isStreaming) {</b>
        <b class="nc"><i>99</i>&nbsp; manager.setRequestProcessing(false)</b>
        <b class="nc"><i>100</i>&nbsp; return</b>
        <i>101</i>&nbsp; }
        <b class="nc"><i>102</i>&nbsp; manager.tryOperationForResult(</b>
        <b class="nc"><i>103</i>&nbsp; { if (!MbtDataBluetooth.instance.stopStream()) {</b>
        <i>104</i>&nbsp; throw BluetoothError.ERROR_WRITE_CHARACTERISTIC_OPERATION
        <i>105</i>&nbsp; } },
        <b class="nc"><i>106</i>&nbsp; BaseErrorEvent { _, _ -&gt;
            MbtDataBluetooth.instance.notifyStreamStateChanged(FAILED) },</b>
        <b class="nc"><i>107</i>&nbsp; { manager.setRequestProcessing(false)},</b>
        <b class="nc"><i>108</i>&nbsp; 6000</b>
        <i>109</i>&nbsp; )
        <b class="nc"><i>110</i>&nbsp; }</b>
        <i>111</i>&nbsp;
        <i>112</i>&nbsp; /** This method is called from Bluetooth classes and is meant to post an
        event to the main manager
        <i>113</i>&nbsp; * that contains the [DeviceInfo] with the associated value
        <i>114</i>&nbsp; * @param deviceInfo the [DeviceInfo]
        <i>115</i>&nbsp; * @param deviceValue the new value as String */
        <i>116</i>&nbsp; fun notifyDeviceInfoReceived(deviceInfo: DeviceInfo, deviceValue: String?)
        {
        <b class="nc"><i>117</i>&nbsp; Log.d(TAG, &quot; Device info returned by the headset
            $deviceInfo : $deviceValue&quot;)</b>
        <b class="nc"><i>118</i>&nbsp; manager.setRequestProcessing(false)</b>
        <b class="nc"><i>119</i>&nbsp; if (deviceInfo == BATTERY &amp;&amp;
            MbtDataBluetooth.instance.currentState == BONDING) {</b>
        <b class="nc"><i>120</i>&nbsp; val connecter = manager.connecter</b>
        <b class="nc"><i>121</i>&nbsp; connecter.updateConnectionState(false) //current state is set
            to BONDED</b>
        <b class="nc"><i>122</i>&nbsp; connecter.switchToNextConnectionStep()</b>
        <i>123</i>&nbsp; } else {
        <b class="nc"><i>124</i>&nbsp; manager.notifyEvent(DeviceInfoEvent(deviceInfo, deviceValue))</b>
        <b class="nc"><i>125</i>&nbsp; }</b>
        <b class="nc"><i>126</i>&nbsp; }</b>
        <i>127</i>&nbsp;
        <i>128</i>&nbsp; fun notifyDeviceResponseReceived(response: Any?, command: DeviceCommand&lt;*,
        *&gt;) {
        <b class="fc"><i>129</i>&nbsp; if (response != null) {</b>
        <b class="nc"><i>130</i>&nbsp; when (command) {</b>
        <b class="nc"><i>131</i>&nbsp; is EegConfig -&gt;
            manager.notifyDeviceConfigReceived(ArrayUtils.toObject(response as ByteArray?))</b>
        <i>132</i>&nbsp;
        <b class="nc"><i>133</i>&nbsp; is UpdateSerialNumber -&gt; (response as ByteArray?)?.let {
            String(it) }?.let { notifyDeviceInfoReceived(SERIAL_NUMBER, it) }</b>
        <i>134</i>&nbsp;
        <b class="nc"><i>135</i>&nbsp; is GetDeviceInfo -&gt; {</b>
        <b class="nc"><i>136</i>&nbsp; notifyDeviceInfoReceived(FW_VERSION,
            String(ArrayUtils.subarray(response as ByteArray?, 0,
            MbtBluetoothSPP.VERSION_NB_BYTES)))</b>
        <b class="nc"><i>137</i>&nbsp; notifyDeviceInfoReceived(HW_VERSION,
            String(ArrayUtils.subarray(response as ByteArray?, MbtBluetoothSPP.VERSION_NB_BYTES,
            MbtBluetoothSPP.VERSION_NB_BYTES + MbtBluetoothSPP.VERSION_NB_BYTES)))</b>
        <b class="nc"><i>138</i>&nbsp; notifyDeviceInfoReceived(SERIAL_NUMBER,
            String(ArrayUtils.subarray(response as ByteArray?, MbtBluetoothSPP.VERSION_NB_BYTES +
            MbtBluetoothSPP.VERSION_NB_BYTES, MbtBluetoothSPP.VERSION_NB_BYTES +
            MbtBluetoothSPP.VERSION_NB_BYTES + MbtBluetoothSPP.SERIAL_NUMBER_NB_BYTES)))</b>
        <i>139</i>&nbsp; }
        <b class="nc"><i>140</i>&nbsp; is UpdateExternalName -&gt;</b>
        <b class="nc"><i>141</i>&nbsp; (response as ByteArray?)?.let { String(it) }?.let {
            notifyDeviceInfoReceived(MODEL_NUMBER, it) }</b>
        <i>142</i>&nbsp;
        <b class="nc"><i>143</i>&nbsp; is GetBattery -&gt;</b>
        <b class="nc"><i>144</i>&nbsp; (response as Int?)?.toString()?.let {
            notifyDeviceInfoReceived(BATTERY, it) }</b>
        <i>145</i>&nbsp;
        <b class="nc"><i>146</i>&nbsp; is OADCommands -&gt; {</b>
        <b class="nc"><i>147</i>&nbsp; manager.connecter.updateConnectionState(UPGRADING)</b>
        <b class="nc"><i>148</i>&nbsp; MbtAudioBluetooth.instance?.currentState = UPGRADING</b>
        <b class="nc"><i>149</i>&nbsp;
            manager.notifyEvent(BluetoothResponseEvent(command.identifier, response))</b>
        <i>150</i>&nbsp; }
        <b class="fc"><i>151</i>&nbsp; }</b>
        <i>152</i>&nbsp; }
        <b class="fc"><i>153</i>&nbsp; }</b>
        <i>154</i>&nbsp;
        <i>155</i>&nbsp; /** Notify a command response has been received from the headset
        <i>156</i>&nbsp; * @param command is the corresponding type of command */
        <i>157</i>&nbsp; fun notifyResponseReceived(response : Any?, command :
        CommandInterface.MbtCommand&lt;*&gt;) {
        <b class="fc"><i>158</i>&nbsp; LogUtils.d(TAG, &quot;Received response from device :
            $response&quot;)</b>
        <i>159</i>&nbsp;
        <b class="fc"><i>160</i>&nbsp; if(command is DeviceCommand&lt;*,*&gt;)</b>
        <b class="fc"><i>161</i>&nbsp; notifyDeviceResponseReceived(response, command)</b>
        <i>162</i>&nbsp;
        <b class="fc"><i>163</i>&nbsp; else if (command is BluetoothCommand&lt;*,*&gt;)</b>
        <b class="fc"><i>164</i>&nbsp; manager.onBluetoothResponseReceived(response, command)</b>
        <i>165</i>&nbsp;
        <b class="fc"><i>166</i>&nbsp; manager.setRequestProcessing(false);</b>
        <b class="fc"><i>167</i>&nbsp; }</b>
        <i>168</i>&nbsp;}
    </div>
</div>

<div class="footer">

    <div style="float:right;">generated on 2020-06-10 10:26</div>
</div>
</body>
</html>
